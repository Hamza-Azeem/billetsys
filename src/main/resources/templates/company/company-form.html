<!--
  Eclipse Public License - v 2.0

    THE ACCOMPANYING PROGRAM IS PROVIDED UNDER THE TERMS OF THIS ECLIPSE
    PUBLIC LICENSE ("AGREEMENT"). ANY USE, REPRODUCTION OR DISTRIBUTION
    OF THE PROGRAM CONSTITUTES RECIPIENT'S ACCEPTANCE OF THIS AGREEMENT.
-->

{#include admin-layout}
    {#content}
        <div class="form-card">
            <h1>{title}</h1>
            <form method="post" action="{action}" onsubmit="selectAll('selectedUsers'); selectAll('selectedTams'); syncEntitlementHidden()">
                <div style="display: grid; grid-template-columns: minmax(0, 1fr); gap: 24px; align-items: start;">
                    <div>
                        <h4>Company</h4>
                        <div>
                            <label>Name
                                <input type="text" name="name" value="{company.name}" required>
                            </label>
                        </div>
                        <div>
                            <label>Address1
                                <input type="text" name="address1" value="{company.address1}">
                            </label>
                        </div>
                        <div>
                            <label>Address2
                                <input type="text" name="address2" value="{company.address2}">
                            </label>
                        </div>
                        <div>
                            <label>City
                                <input type="text" name="city" value="{company.city}">
                            </label>
                        </div>
                        <div>
                            <label>State
                                <input type="text" name="state" value="{company.state}">
                            </label>
                        </div>
                        <div>
                            <label>Zip
                                <input type="text" name="zip" value="{company.zip}">
                            </label>
                        </div>
                        <div>
                            <label>Phone Number
                                <input type="text" name="phoneNumber" value="{company.phoneNumber}">
                            </label>
                        </div>
                        <div>
                            <label>Country
                                    {#countrySelect selectedCountry=company.country countries=countries includePlaceholder=false /}
                            </label>
                        </div>
                        <div>
                            <label>Time Zone
                                    {#timezoneSelect selectedTimezone=company.timezone timezones=timezones includePlaceholder=false /}
                            </label>
                        </div>
                    <div style="display: grid; gap: 24px; margin-top: 15px">
                        <div>
                            <label style="font-weight: 600;">Entitlements</label>
                            <div style="display: grid; gap: 12px;">
                                <div>
                                    <table style="width: 100%;">
                                        <thead>
                                        <tr>
                                            <th>Entitlement</th>
                                            <th>Level</th>
                                            <th>Date</th>
                                            <th>Duration</th>
                                            <th></th>
                                        </tr>
                                        </thead>
                                        <tbody id="entitlementRows">
                                        {#for entry in companyEntitlements}
                                            <tr data-entitlement-id="{entry.entitlement.id}" data-level-id="{entry.supportLevel.id}">
                                                <td>{entry.entitlement.name}</td>
                                                <td>{entry.supportLevel.name}</td>
                                                <td><input type="date" value="{entry.date}" required></td>
                                                <td>
                                                    <select required>
                                                        <option value="1" {#if entry.duration != null && entry.duration == 1}selected{/if}>Monthly</option>
                                                        <option value="2" {#if entry.duration == null || entry.duration == 2}selected{/if}>Yearly</option>
                                                    </select>
                                                </td>
                                                <td><button type="button" class="action-button" onclick="removeEntitlementRow(this)">Remove</button></td>
                                            </tr>
                                        {/for}
                                        </tbody>
                                    </table>
                                </div>
                                <div style="display: grid; grid-template-columns: minmax(0, 1fr) minmax(0, 1fr) minmax(0, 1fr) minmax(0, 1fr) auto; gap: 12px; align-items: end;">
                                    <div>
                                        <label style="font-weight: 600;">Entitlement</label>
                                        <select id="entitlementPicker">
                                            <option value="">Select entitlement</option>
                                            {#for entitlement in entitlements}
                                                <option value="{entitlement.id}">{entitlement.name}</option>
                                            {/for}
                                        </select>
                                    </div>
                                    <div>
                                        <label style="font-weight: 600;">Level</label>
                                        <select id="supportLevelPicker">
                                            {#for level in supportLevels}
                                                <option value="{level.id}" data-level-value="{level.level}">{level.name}</option>
                                            {/for}
                                        </select>
                                    </div>
                                    <div>
                                        <label style="font-weight: 600;">Date</label>
                                        <input type="date" id="entitlementDatePicker" required>
                                    </div>
                                    <div>
                                        <label style="font-weight: 600;">Duration</label>
                                        <select id="entitlementDurationPicker" required>
                                            <option value="1">Monthly</option>
                                            <option value="2" selected>Yearly</option>
                                        </select>
                                    </div>
                                    <button type="button" class="action-button" onclick="addEntitlementPair()">Add</button>
                                </div>
                                <div id="entitlementHidden"></div>
                            </div>
                        </div>
                        <div>
                            <div style="display: grid; grid-template-columns: minmax(0, 1fr) auto minmax(0, 1fr); gap: 12px; align-items: start;">
                                <div>
                                    <label style="font-weight: 600;">Users available</label>
                                    <select id="availableUsers" multiple size="10" style="width: 100%;">
                                        {#for user in users}
                                            {#if !selectedUserIds.contains(user.id)}
                                                <option value="{user.id}">{user.name}</option>
                                            {/if}
                                        {/for}
                                    </select>
                                </div>
                                <div style="display: grid; gap: 8px;">
                                    <button type="button" class="secondary-button" onclick="moveSelected('availableUsers', 'selectedUsers')">→</button>
                                    <button type="button" class="secondary-button" onclick="moveSelected('selectedUsers', 'availableUsers')">←</button>
                                </div>
                                <div>
                                    <label style="font-weight: 600;">Company users</label>
                                    <select id="selectedUsers" name="userIds" multiple size="10" style="width: 100%;">
                                        {#for user in users}
                                            {#if selectedUserIds.contains(user.id)}
                                                <option value="{user.id}" {#if primaryContact != null &&
                                                user.id == primaryContact.id} disabled {/if}>{user.name} </option>
                                            {/if}
                                        {/for}
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div>
                            <div style="display: grid; grid-template-columns: minmax(0, 1fr) auto minmax(0, 1fr); gap: 12px; align-items: start;">
                                <div>
                                    <label style="font-weight: 600;">TAMs available</label>
                                    <select id="availableTams" multiple size="10" style="width: 100%;">
                                        {#for tam in tams}
                                            {#if !selectedTamIds.contains(tam.id)}
                                                <option value="{tam.id}">{tam.name}</option>
                                            {/if}
                                        {/for}
                                    </select>
                                </div>
                                <div style="display: grid; gap: 8px;">
                                    <button type="button" class="secondary-button" onclick="moveSelected('availableTams', 'selectedTams')">→</button>
                                    <button type="button" class="secondary-button" onclick="moveSelected('selectedTams', 'availableTams')">←</button>
                                </div>
                                <div>
                                    <label style="font-weight: 600;">Company TAMs</label>
                                    <select id="selectedTams" name="tamIds" multiple size="10" style="width: 100%;">
                                        {#for tam in tams}
                                            {#if selectedTamIds.contains(tam.id)}
                                                <option value="{tam.id}">{tam.name}</option>
                                            {/if}
                                        {/for}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                    <div>
                        <h4>Primary Contact</h4>
                        {#if primaryContact.id == null}
                            <div>
                                <label> Username
                                    <input type="text" name="primaryContactUsername" value="{primaryContact.name}" required>
                                </label>
                            </div>
                            <div>
                                <label>Full Name
                                    <input type="text" name="primaryContactFullName" value="{primaryContact.fullName}">
                                </label>
                            </div>
                            <div>
                                <label> Email
                                    <input type="text" name="primaryContactEmail" value="{primaryContact.email}" required>
                                </label>
                            </div>
                            <div>
                                <label>Social
                                    <input type="text" name="primaryContactSocial" value="{primaryContact.social}">
                                </label>
                            </div>
                            <div>
                                <label> Phone Number
                                    <input type="text" name="primaryContactPhoneNumber"
                                           value="{primaryContact.phoneNumber}">
                                </label>
                            </div>
                            <div>
                                <label> Phone Number Extension
                                    <input type="text" name="primaryPhoneNumberExtension"
                                           value="{primaryContact.phoneExtension}">
                                </label>
                            </div>
                            <div>
                                <label> Country
                                        {#countrySelect customId="primaryContactCountry" customName="primaryContactCountry"
                                        selectedCountry=primaryContact.country countries=countries /}
                                </label>
                            </div>
                            <div>
                                <label>Time Zone
                                        {#timezoneSelect customName="primaryContactTimeZone" customId="primaryContactTimeZone"
                                        selectedTimezone=primaryContact.timezone timezones=timezones /}
                                </label>
                            </div>
                            <div>
                                <label>
                                    Password
                                    <input type="password" name="primaryContactPassword" {#if primaryContact.id == null}required{/if}>
                                    {#if primaryContact.id != null}
                                        <small>Leave blank to keep the current password.</small>
                                    {/if}
                                </label>
                            </div>
                        {#else}
                            <label aria-label="Primary contact">
                            <select style="width: 100%;" name="primaryContact">
                                {#for user in users}
                                    {#if selectedUserIds.contains(user.id)}
                                        <option value="{user.id}" {#if user.id == primaryContact.id} selected {/if}>{user.name}</option>
                                    {/if}
                                {/for}
                            </select>
                            </label>
                        {/if}
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="action-button">Save</button>
                </div>
            </form>
        </div>

        <script>
            function moveSelected(sourceId, targetId) {
                const source = document.getElementById(sourceId);
                const target = document.getElementById(targetId);
                const selected = Array.from(source.selectedOptions);
                selected.forEach(option => {
                    source.removeChild(option);
                    option.selected = false;
                    target.appendChild(option);
                });
            }

            function selectAll(selectId) {
                const select = document.getElementById(selectId);
                if (!select) {
                    return;
                }
                Array.from(select.options).forEach(option => {
                    option.disabled = false;
                    option.selected = true;
                });
            }

            function addEntitlementPair() {
                const entitlementPicker = document.getElementById('entitlementPicker');
                const levelPicker = document.getElementById('supportLevelPicker');
                const datePicker = document.getElementById('entitlementDatePicker');
                const durationPicker = document.getElementById('entitlementDurationPicker');
                const rows = document.getElementById('entitlementRows');
                if (!entitlementPicker || !levelPicker || !datePicker || !durationPicker || !rows) {
                    return;
                }
                if (!entitlementPicker.value || !levelPicker.value || !datePicker.value || !durationPicker.value) {
                    return;
                }
                const entitlementId = entitlementPicker.value;
                const entitlementText = entitlementPicker.options[entitlementPicker.selectedIndex].textContent;
                const selectedLevelOption = levelPicker.options[levelPicker.selectedIndex];
                const dateValue = datePicker.value;
                const durationValue = durationPicker.value;
                const selectedLevelValue = Number(selectedLevelOption.getAttribute('data-level-value'));
                const levelOptions = [selectedLevelOption];
                if (!Number.isNaN(selectedLevelValue)) {
                    Array.from(levelPicker.options).forEach((option) => {
                        const value = Number(option.getAttribute('data-level-value'));
                        if (!Number.isNaN(value) && value > selectedLevelValue) {
                            levelOptions.push(option);
                        }
                    });
                }
                levelOptions.forEach((option) => {
                    addEntitlementRow(rows, entitlementId, entitlementText, option.value, option.textContent, dateValue, durationValue);
                });
                entitlementPicker.selectedIndex = 0;
                levelPicker.selectedIndex = 0;
            }

            function addEntitlementRow(rows, entitlementId, entitlementText, levelId, levelText, dateValue, durationValue) {
                const exists = Array.from(rows.querySelectorAll('tr')).some((row) =>
                    row.dataset.entitlementId === entitlementId && row.dataset.levelId === levelId
                );
                if (exists) {
                    return;
                }
                const row = document.createElement('tr');
                row.dataset.entitlementId = entitlementId;
                row.dataset.levelId = levelId;
                row.innerHTML =
                    '<td>' + entitlementText + '</td>' +
                    '<td>' + levelText + '</td>' +
                    '<td><input type="date" value="' + dateValue + '" required></td>' +
                    '<td><select required><option value="1"' + (durationValue === '1' ? ' selected' : '') + '>Monthly</option><option value="2"' + (durationValue === '2' ? ' selected' : '') + '>Yearly</option></select></td>' +
                    '<td><button type="button" class="action-button" onclick="removeEntitlementRow(this)">Remove</button></td>';
                rows.appendChild(row);
            }

            function syncEntitlementHidden() {
                const rows = document.getElementById('entitlementRows');
                const container = document.getElementById('entitlementHidden');
                if (!rows || !container) {
                    return;
                }
                container.innerHTML = '';
                Array.from(rows.querySelectorAll('tr')).forEach(row => {
                    const entitlementId = row.dataset.entitlementId;
                    const levelId = row.dataset.levelId;
                    const dateInput = row.querySelector('input[type="date"]');
                    const durationInput = row.querySelector('select');
                    if (!entitlementId || !levelId) {
                        return;
                    }
                    const entitlementInput = document.createElement('input');
                    entitlementInput.type = 'hidden';
                    entitlementInput.name = 'entitlementIds';
                    entitlementInput.value = entitlementId;
                    container.appendChild(entitlementInput);
                    const levelInput = document.createElement('input');
                    levelInput.type = 'hidden';
                    levelInput.name = 'levelIds';
                    levelInput.value = levelId;
                    container.appendChild(levelInput);
                    const dateHiddenInput = document.createElement('input');
                    dateHiddenInput.type = 'hidden';
                    dateHiddenInput.name = 'entitlementDates';
                    dateHiddenInput.value = dateInput ? dateInput.value : '';
                    container.appendChild(dateHiddenInput);
                    const durationHiddenInput = document.createElement('input');
                    durationHiddenInput.type = 'hidden';
                    durationHiddenInput.name = 'entitlementDurations';
                    durationHiddenInput.value = durationInput ? durationInput.value : '2';
                    container.appendChild(durationHiddenInput);
                });
            }

            function removeEntitlementRow(button) {
                const row = button ? button.closest('tr') : null;
                if (row) {
                    row.remove();
                }
            }

            document.addEventListener('DOMContentLoaded', () => {
                const datePicker = document.getElementById('entitlementDatePicker');
                if (datePicker && !datePicker.value) {
                    datePicker.value = new Date().toISOString().slice(0, 10);
                }
            });

            function loadTimezones(select) {
                const target = select.id;
                var countryId = document.getElementById(select.id).value;
                var tzSelect = target === 'primaryContactCountry' ? document.getElementById('primaryContactTimeZone') : document.getElementById('timezoneSelect');
                tzSelect.innerHTML = '';
                if (!countryId) return;
                fetch('/timezones?countryId=' + countryId)
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        for (var i = 0; i < data.length; i++) {
                            var opt = document.createElement('option');
                            opt.value = data[i].id;
                            opt.textContent = data[i].name;
                            tzSelect.appendChild(opt);
                        }
                        if (data.length > 0) {
                            var nyOption = Array.from(tzSelect.options).find(function(opt) {
                                return opt.textContent === 'America/New_York';
                            });
                            if (nyOption) {
                                nyOption.selected = true;
                            } else {
                                tzSelect.options[0].selected = true;
                            }
                        }
                    });
            }
        </script>
    {/content}
{/include}
