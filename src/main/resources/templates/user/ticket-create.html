<!--
  Eclipse Public License - v 2.0

    THE ACCOMPANYING PROGRAM IS PROVIDED UNDER THE TERMS OF THIS ECLIPSE
    PUBLIC LICENSE ("AGREEMENT"). ANY USE, REPRODUCTION OR DISTRIBUTION
    OF THE PROGRAM CONSTITUTES RECIPIENT'S ACCEPTANCE OF THIS AGREEMENT.
-->

{#include support-layout}
{#content}
<div class="form-card full-width">
    <h1>{#if ticketName?? && !ticketName.isBlank}{ticketName}{#else}{#if ticket.name?? && !ticket.name.isBlank}{ticket.name}{#else}Â {/if}{/if}</h1>
    <form method="post" action="/user/tickets" enctype="multipart/form-data">
        <div>
            <label>Ticket
                <input type="text" name="ticketName" value="{#if ticketName??}{ticketName}{/if}" readonly>
            </label>
        </div>
        <div>
            <label>Category
                <select name="categoryId">
                    {#for cat in categories}
                        <option value="{cat.id}" {#if defaultCategoryId != null && defaultCategoryId == cat.id}selected{/if}>{cat.name}</option>
                    {/for}
                </select>
            </label>
        </div>
        <input type="hidden" name="status" value="Open">
        <div>
            <label class="markdown-label" for="user-ticket-message">Message</label>
            <div class="markdown-editor" data-markdown-editor>
                <div class="markdown-toolbar" data-md-toolbar>
                    <button type="button" data-md-action="bold" aria-label="Bold"><strong>B</strong></button>
                    <button type="button" data-md-action="italic" aria-label="Italic"><em>I</em></button>
                    <button type="button" data-md-action="heading" aria-label="Heading">H</button>
                    <button type="button" data-md-action="list" aria-label="List">List</button>
                    <button type="button" data-md-action="quote" aria-label="Quote">Quote</button>
                    <button type="button" data-md-action="code" aria-label="Code"><code>{}</code></button>
                    <button type="button" data-md-action="code-block" aria-label="Code block">Code</button>
                    <button type="button" data-md-action="link" aria-label="Link">Link</button>
                </div>
                <div class="markdown-panels">
                    <div class="markdown-panel">
                        <div class="markdown-panel-header">Write</div>
                        <textarea id="user-ticket-message" name="message" rows="6" required data-md-input>{#if message??}{message}{/if}</textarea>
                    </div>
                    <div class="markdown-panel">
                        <div class="markdown-panel-header">Preview</div>
                        <div class="markdown-preview" data-md-preview></div>
                    </div>
                </div>
            </div>
        </div>
        <div data-attachment-container>
            <span class="attachment-label">Attachments</span>
            <div class="attachment-list" data-attachment-list>
                <table>
                    <thead>
                    <tr>
                        <th>Name</th>
                        <th>Mimetype</th>
                        <th>Size</th>
                        <th></th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <input type="file" name="attachments" multiple data-attachment-input class="attachment-input">
            <div class="attachment-actions">
                <button type="button" class="action-button" data-attachment-trigger>Browse</button>
            </div>
        </div>
        {#if companyEntitlements.size == 1}
        {#for entry in companyEntitlements}
        <div>
            <label>Entitlement
                <input type="text" value="{entry.entitlement.name}" readonly>
            </label>
            <input type="hidden" name="companyEntitlementId" value="{entry.id}" data-expired="{#if expiredEntitlementIds.contains(entry.id)}true{#else}false{/if}">
        </div>
        {/for}
        {#else}
        <div>
            <label>Entitlement
                <select id="companyEntitlementId" name="companyEntitlementId" required>
                    {#for entry in companyEntitlements}
                    <option value="{entry.id}" data-expired="{#if expiredEntitlementIds.contains(entry.id)}true{#else}false{/if}">{entry.entitlement.name}</option>
                    {/for}
                </select>
            </label>
        </div>
        {/if}
        <div class="form-actions">
            <button id="create-ticket-button" type="submit" class="action-button">Create</button>
        </div>
    </form>
</div>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const select = document.getElementById("companyEntitlementId");
        const button = document.getElementById("create-ticket-button");
        if (!button) {
            return;
        }
        const applyDisabledStyle = () => {
            if (button.disabled) {
                button.style.backgroundColor = "#9e9e9e";
                button.style.cursor = "not-allowed";
            } else {
                button.style.backgroundColor = "";
                button.style.cursor = "";
            }
        };
        if (!select) {
            const hidden = document.querySelector('input[name="companyEntitlementId"]');
            button.disabled = hidden != null && hidden.getAttribute("data-expired") === "true";
            applyDisabledStyle();
            return;
        }
        const updateCreateState = () => {
            const selected = select.options[select.selectedIndex];
            const expired = selected && selected.getAttribute("data-expired") === "true";
            button.disabled = !!expired;
            applyDisabledStyle();
        };
        select.addEventListener("change", updateCreateState);
        updateCreateState();
    });
</script>
{/content}
{/include}
